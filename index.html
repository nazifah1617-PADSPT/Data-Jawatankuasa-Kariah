<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Maklumat Kariah & Masjid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%); 
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1.5" fill="white" opacity="0.15"/><circle cx="75" cy="75" r="1.5" fill="white" opacity="0.15"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="1" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="1" fill="white" opacity="0.1"/><circle cx="30" cy="80" r="0.5" fill="white" opacity="0.2"/><circle cx="70" cy="20" r="0.5" fill="white" opacity="0.2"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }
        .card-hover { 
            position: relative;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-input { 
            transition: all 0.4s ease; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .search-input:focus { 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2), 0 8px 25px rgba(0,0,0,0.1); 
            background: rgba(255, 255, 255, 1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            box-shadow: 0 8px 25px rgba(30, 41, 59, 0.3);
            border: none;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            box-shadow: 0 15px 35px rgba(30, 41, 59, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
        }
        .btn-secondary:hover {
            box-shadow: 0 15px 35px rgba(100, 116, 139, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            box-shadow: 0 8px 25px rgba(55, 65, 81, 0.3);
        }
        .btn-success:hover {
            box-shadow: 0 15px 35px rgba(55, 65, 81, 0.4);
        }
        .btn-purple {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white !important;
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }
        .btn-purple:hover {
            box-shadow: 0 15px 35px rgba(107, 114, 128, 0.4);
        }
        .loading-spinner { 
            animation: spin 1s linear infinite; 
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(30px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .result-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            z-index: -1;
        }
        .result-card:hover {
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4">
            <div class="text-center relative z-10">
                <h1 class="text-4xl font-bold mb-2 uppercase">üïå Sistem Maklumat Kariah Daerah Seberang Perai Tengah</h1>
                <p class="text-xl opacity-90 uppercase">Carian Jawatankuasa Masjid, Surau dan Pegawai Masjid</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="bg-white rounded-xl shadow-lg mb-8 card-hover">
            <div class="py-6 px-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800 uppercase">üë• Jawatankuasa Kariah</h2>
                <p class="text-gray-600 mt-2 uppercase">Carian maklumat jawatankuasa masjid, surau dan pegawai masjid</p>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 card-hover">
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 uppercase">üïå Pilih Masjid</label>
                    <select id="masjidSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl search-input focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Semua Masjid</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 uppercase">üëî Pilih Jawatan</label>
                    <select id="jawatanSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl search-input focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Semua Jawatan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 uppercase">üîç Cari Nama</label>
                    <input type="text" id="searchInput" placeholder="Masukkan nama untuk carian..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl search-input focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="mt-8 flex gap-6 flex-wrap justify-center">
                <button id="searchBtn" class="btn-primary text-white px-8 py-4 rounded-2xl font-bold transition-all flex items-center gap-3 uppercase relative overflow-hidden">
                    <span class="loading-spinner hidden text-xl">‚ü≥</span>
                    <span class="relative z-10">üîç Cari Maklumat</span>
                </button>
                <button id="clearBtn" class="btn-secondary text-white px-8 py-4 rounded-2xl font-bold transition-all uppercase relative overflow-hidden">
                    <span class="relative z-10">üóëÔ∏è Kosongkan</span>
                </button>
                <button id="browserPrintBtn" class="btn-success text-white px-8 py-4 rounded-2xl font-bold transition-all uppercase relative overflow-hidden">
                    <span class="relative z-10">üñ®Ô∏è Cetak</span>
                </button>
                <button id="refreshBtn" class="btn-purple px-8 py-4 rounded-2xl font-bold transition-all uppercase relative overflow-hidden">
                    <span class="relative z-10">üîÑ Muat Semula Data</span>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 uppercase">üìã Keputusan Carian</h3>
                    <span id="resultCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold uppercase"></span>
                </div>
                <div id="resultsContainer" class="space-y-4"></div>
            </div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2 uppercase">Tiada Keputusan Dijumpai</h3>
            <p class="text-gray-500 uppercase">Cuba ubah kriteria carian anda</p>
        </div>
    </div>

    <script>
        // CARA MUDAH: Google Sheets Configuration (Tanpa API Key!)
        const GOOGLE_SHEETS_CONFIG = {
            // Published CSV URL yang anda berikan
            PUBLISHED_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQbaidIqA7QCvVDjYHDTWHn2j5js2IU-Y9AIkq-7HQm1rcvphwRjFV_AUm_wvxaAQ/pub?output=csv'
        };

        // Cache untuk data
        let jawatankuasaData = [];
        let dataLoaded = false;

        // Function untuk load data dari Google Sheets (OPTIMIZED - Lightweight)
        async function loadDataFromGoogleSheets() {
            try {
                // Optimized fetch with timeout and cache
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.PUBLISHED_CSV_URL, {
                    signal: controller.signal,
                    cache: 'default', // Use browser cache when available
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvData = await response.text();
                
                // Quick validation and processing
                if (csvData && csvData.length > 50) {
                    // Process data in chunks to avoid blocking UI
                    await processDataInChunks(csvData);
                    
                    dataLoaded = true;
                    
                    showSuccessMessage(`üöÄ Data dimuat berjaya! ${jawatankuasaData.length} rekod tersedia.`);
                } else {
                    throw new Error('Data kosong atau tidak lengkap');
                }
                
            } catch (error) {
                console.error('Loading error:', error);
                
                if (error.name === 'AbortError') {
                    showErrorMessage('‚è±Ô∏è Sambungan terlalu lambat. Cuba sekali lagi.');
                } else {
                    showErrorMessage(`‚ùå Gagal memuat data: ${error.message}`);
                }
                
                loadSampleData();
            }
        }

        // Process data in chunks to prevent UI blocking
        async function processDataInChunks(csvData) {
            return new Promise((resolve) => {
                const lines = csvData.split('\n');
                jawatankuasaData = [];
                
                let index = 1; // Skip header
                
                function processChunk() {
                    const chunkSize = 50; // Process 50 rows at a time
                    const endIndex = Math.min(index + chunkSize, lines.length);
                    
                    for (let i = index; i < endIndex; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const columns = parseCSVLine(line);
                            if (columns.length >= 8 && columns[2]) {
                                const calculatedAge = calculateAgeFromIC(columns[3]);
                                jawatankuasaData.push({
                                    masjid: columns[0] || '',
                                    jawatan: columns[1] || '',
                                    nama: columns[2] || '',
                                    kp: columns[3] || '',
                                    noTel: columns[4] || '',
                                    alamat: columns[5] || '',
                                    pekerjaan: columns[6] || '',
                                    umur: calculatedAge || columns[7] || ''
                                });
                            }
                        }
                    }
                    
                    index = endIndex;
                    
                    if (index < lines.length) {
                        // Continue processing in next frame
                        requestAnimationFrame(processChunk);
                    } else {
                        // Finished processing
                        populateMasjidDropdown();
                        populateJawatanDropdown();
                        resolve();
                    }
                }
                
                processChunk();
            });
        }

        // Function untuk calculate umur dari No. KP
        function calculateAgeFromIC(icNumber) {
            if (!icNumber || icNumber.length < 6) return null;
            
            try {
                // Extract birth date from IC (YYMMDD format)
                const yearPart = icNumber.substring(0, 2);
                const month = parseInt(icNumber.substring(2, 4));
                const day = parseInt(icNumber.substring(4, 6));
                
                // Determine full year (assume 1900s for years 00-99, adjust as needed)
                let birthYear;
                const currentYear = new Date().getFullYear();
                const currentYearLastTwo = currentYear % 100;
                
                // If year part is greater than current year's last two digits, it's from 1900s
                if (parseInt(yearPart) > currentYearLastTwo) {
                    birthYear = 1900 + parseInt(yearPart);
                } else {
                    birthYear = 2000 + parseInt(yearPart);
                }
                
                // Validate month and day
                if (month < 1 || month > 12 || day < 1 || day > 31) {
                    return null;
                }
                
                // Calculate age
                const birthDate = new Date(birthYear, month - 1, day);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                
                // Adjust if birthday hasn't occurred this year
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age > 0 && age < 150 ? age.toString() : null;
            } catch (error) {
                return null;
            }
        }

        // Function untuk convert CSV ke format object
        function convertCsvToObjects(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            // Skip header row (index 0) and process data rows
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // Advanced CSV parsing to handle commas within quoted fields
                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 8 && columns[2]) { // Ensure we have enough columns and nama is not empty
                        // Calculate age from IC number if available
                        const calculatedAge = calculateAgeFromIC(columns[3]);
                        
                        result.push({
                            masjid: columns[0] || '',      // Kolum A: MASJID
                            jawatan: columns[1] || '',     // Kolum B: JAWATAN  
                            nama: columns[2] || '',        // Kolum C: NAMA
                            kp: columns[3] || '',          // Kolum D: KP
                            noTel: columns[4] || '',       // Kolum E: NO. TEL
                            alamat: columns[5] || '',      // Kolum F: ALAMAT
                            pekerjaan: columns[6] || '',   // Kolum G: PEKERJAAN
                            umur: calculatedAge || columns[7] || ''  // Auto-calculate or use Kolum H: UMUR
                        });
                    }
                }
            }
            
            return result;
        }

        // Function untuk parse CSV line dengan betul (handle commas dalam quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            return result;
        }

        // Fallback sample data
        function loadSampleData() {
            jawatankuasaData = [];
            dataLoaded = true;
        }

        // Function untuk populate masjid dropdown
        function populateMasjidDropdown() {
            const masjidSelect = document.getElementById('masjidSelect');
            const uniqueMasjids = [...new Set(jawatankuasaData.map(item => item.masjid))].filter(masjid => masjid);
            
            // Clear existing options except "Semua Masjid"
            masjidSelect.innerHTML = '<option value="">Semua Masjid</option>';
            
            // Add unique masjids
            uniqueMasjids.forEach(masjid => {
                const option = document.createElement('option');
                option.value = masjid;
                option.textContent = masjid;
                masjidSelect.appendChild(option);
            });
        }

        // Function untuk populate jawatan dropdown
        function populateJawatanDropdown() {
            const jawatanSelect = document.getElementById('jawatanSelect');
            const uniqueJawatan = [...new Set(jawatankuasaData.map(item => item.jawatan))].filter(jawatan => jawatan);
            
            // Clear existing options except "Semua Jawatan"
            jawatanSelect.innerHTML = '<option value="">Semua Jawatan</option>';
            
            // Add unique jawatan
            uniqueJawatan.forEach(jawatan => {
                const option = document.createElement('option');
                option.value = jawatan;
                option.textContent = jawatan;
                jawatanSelect.appendChild(option);
            });
        }

        // Function untuk show loading message
        function showLoadingMessage(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm';
            loadingDiv.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 text-center max-w-sm mx-4 border border-white/20">
                    <div class="loading-spinner text-6xl mb-6 pulse-animation">‚ö°</div>
                    <p class="text-xl font-bold text-white mb-2">${message}</p>
                    <div class="flex justify-center space-x-1 mt-4">
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        // Function untuk hide loading message
        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('loadingMessage');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Function untuk show error message
        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        // Function untuk show success message
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        // Generic message function
        function showMessage(message, type = 'error') {
            // Remove existing messages first
            const existingMessages = document.querySelectorAll('.status-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            
            if (type === 'success') {
                messageDiv.className = 'status-message glass-effect border-l-4 border-green-400 text-green-800 p-4 mb-6 rounded-xl fade-in';
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-2xl">‚úÖ</div>
                        <div class="ml-3">
                            <div class="font-medium">${message}</div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.className = 'status-message glass-effect border-l-4 border-yellow-400 text-yellow-800 p-4 mb-6 rounded-xl fade-in';
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-2xl">‚ö†Ô∏è</div>
                        <div class="ml-3">
                            <div class="font-medium">${message}</div>
                        </div>
                    </div>
                `;
            }
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transform = 'translateY(-20px)';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 8000);
        }

        let currentResults = [];

        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('clearBtn').addEventListener('click', clearSearch);
        document.getElementById('browserPrintBtn').addEventListener('click', printWithBrowserPrint);
        document.getElementById('refreshBtn').addEventListener('click', refreshData);

        // Enter key search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            // Ensure data is loaded first
            if (!dataLoaded) {
                await loadDataFromGoogleSheets();
            }
            
            const masjid = document.getElementById('masjidSelect').value;
            const jawatan = document.getElementById('jawatanSelect').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const searchBtn = document.getElementById('searchBtn');
            const spinner = searchBtn.querySelector('.loading-spinner');
            
            // Show loading
            spinner.classList.remove('hidden');
            searchBtn.disabled = true;
            
            setTimeout(() => {
                let results = jawatankuasaData.filter(item => {
                    const matchesMasjid = !masjid || item.masjid === masjid;
                    const matchesJawatan = !jawatan || item.jawatan === jawatan;
                    const matchesSearch = !searchTerm || 
                        item.nama.toLowerCase().includes(searchTerm) ||
                        item.jawatan.toLowerCase().includes(searchTerm) ||
                        item.kp.includes(searchTerm) ||
                        item.alamat.toLowerCase().includes(searchTerm) ||
                        item.noTel.includes(searchTerm) ||
                        item.pekerjaan.toLowerCase().includes(searchTerm);
                    
                    return matchesMasjid && matchesJawatan && matchesSearch;
                });
                
                displayResults(results);
                
                // Hide loading
                spinner.classList.add('hidden');
                searchBtn.disabled = false;
            }, 300);
        }

        function displayResults(results) {
            currentResults = results;
            const resultsSection = document.getElementById('resultsSection');
            const noResults = document.getElementById('noResults');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultCount = document.getElementById('resultCount');
            
            if (results.length === 0) {
                resultsSection.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            resultCount.textContent = `${results.length} rekod dijumpai`;
            
            resultsContainer.innerHTML = results.map(item => `
                <div class="result-card rounded-2xl p-8 transition-all fade-in">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-xl text-blue-700 mb-4 uppercase">üë§ ${item.nama}</h4>
                            <div class="space-y-3 text-sm">
                                <p><span class="font-semibold text-gray-700 uppercase">üïå Masjid:</span> <span class="text-green-600 font-medium">${item.masjid}</span></p>
                                <p><span class="font-semibold text-gray-700 uppercase">üëî Jawatan:</span> <span class="text-purple-600 font-semibold">${item.jawatan}</span></p>
                                <p><span class="font-semibold text-gray-700 uppercase">üÜî No. K/P:</span> <span class="font-mono text-gray-800">${item.kp}</span></p>
                                <p><span class="font-semibold text-gray-700 uppercase">üìû No. Tel:</span> <span class="font-mono text-blue-600 font-medium">${item.noTel}</span></p>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm">
                            <p><span class="font-semibold text-gray-700 uppercase">üè† Alamat:</span><br><span class="text-gray-700 leading-relaxed">${item.alamat}</span></p>
                            <p><span class="font-semibold text-gray-700 uppercase">üíº Pekerjaan:</span> <span class="text-indigo-600 font-medium">${item.pekerjaan}</span></p>
                            <p><span class="font-semibold text-gray-700 uppercase">üéÇ Umur:</span> <span class="text-orange-600 font-bold text-lg">${item.umur} tahun</span></p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('masjidSelect').value = '';
            document.getElementById('jawatanSelect').value = '';
            document.getElementById('searchInput').value = '';
            clearResults();
        }

        function clearResults() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            currentResults = [];
        }



        // Browser print function (always works)
        function printWithBrowserPrint() {
            if (currentResults.length === 0) {
                alert('Tiada data untuk dicetak. Sila lakukan carian terlebih dahulu.');
                return;
            }

            // Create a new window with printable content
            const printWindow = window.open('', '_blank');
            const today = new Date();
            const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            const selectedMasjid = document.getElementById('masjidSelect').value;
            const selectedJawatan = document.getElementById('jawatanSelect').value;
            
            // Determine if we need Masjid column (when filtering by jawatan but not masjid)
            const needMasjidColumn = selectedJawatan && !selectedMasjid;
            
            let printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Senarai Jawatankuasa Kariah</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; color: #333; margin-bottom: 5px; }
                        h2 { text-align: center; color: #667eea; margin-bottom: 15px; font-size: 18px; }
                        .info { margin-bottom: 20px; font-size: 14px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #667eea; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .alamat { max-width: 150px; word-wrap: break-word; }
                        @media print { 
                            body { margin: 0; }
                            .no-print { display: none; }
                            table { font-size: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üïå Senarai Jawatankuasa Kariah</h1>
                    ${selectedMasjid ? `<h2>${selectedMasjid}</h2>` : ''}
                    <div class="info">
                        <p><strong>Tarikh:</strong> ${dateStr}</p>
                        <p><strong>Jumlah Rekod:</strong> ${currentResults.length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                ${needMasjidColumn ? '<th>Masjid</th>' : ''}
                                <th>Jawatan</th>
                                <th>Nama</th>
                                <th>No. K/P</th>
                                <th>No. Tel</th>
                                <th>Alamat</th>
                                <th>Pekerjaan</th>
                                <th>Umur</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentResults.forEach(item => {
                printContent += `
                    <tr>
                        ${needMasjidColumn ? `<td>${item.masjid || ''}</td>` : ''}
                        <td>${item.jawatan || ''}</td>
                        <td>${item.nama || ''}</td>
                        <td>${item.kp || ''}</td>
                        <td>${item.noTel || ''}</td>
                        <td class="alamat">${item.alamat || ''}</td>
                        <td>${item.pekerjaan || ''}</td>
                        <td>${item.umur || ''}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è Cetak Sekarang</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">‚ùå Tutup</button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Auto focus and show print dialog
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Function untuk refresh data
        async function refreshData() {
            dataLoaded = false;
            jawatankuasaData = [];
            clearResults();
            await loadDataFromGoogleSheets();
            showSuccessMessage('Data telah dimuat semula dari Google Sheets!');
        }

        // Initialize - Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataFromGoogleSheets();
            // Don't auto search - let user search manually
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a9dd0d21f471e8',t:'MTc1OTgwMzA0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
